import { crc32 } from '../utils/crc32.js';
import { FF_MARKER } from './Constants.js';
export class PacketParser {
    static parse(buffer) {
        if (buffer.length < 7) {
            return { isValid: false, error: 'too_short' };
        }
        if (buffer[0] !== 0x42 || buffer[1] !== 0x45) {
            return { isValid: false, error: 'invalid_header' };
        }
        const packetCrc = buffer.readInt32LE(2);
        const payload = buffer.subarray(6);
        if (payload.length < 2) {
            return { isValid: false, error: 'too_short' };
        }
        const calculatedCrc = crc32(payload);
        if (packetCrc !== calculatedCrc) {
            return { isValid: false, error: 'crc_mismatch' };
        }
        if (payload[0] !== FF_MARKER) {
            return { isValid: false, error: 'invalid_marker' };
        }
        const typeByte = payload[1];
        const type = typeByte;
        const body = payload.subarray(2);
        return {
            isValid: true,
            type,
            body
        };
    }
    static isMultipart(body) {
        const marker = body[1];
        return body.length >= 4 && marker === 0x00;
    }
    static parseMultipartHeader(body) {
        const sequence = body[0] ?? 0;
        const total = body[2] ?? 0;
        const index = body[3] ?? 0;
        const data = body.subarray(4);
        return { sequence, total, index, data };
    }
}
//# sourceMappingURL=PacketParser.js.map